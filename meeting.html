<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æœƒè­°å®¤ (å¤šäºº) - å³æ™‚èªéŸ³è½‰æ–‡å­—</title>
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="styles/meeting.css">

    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- PeerJS SDK -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        .audio-unlock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .audio-unlock-content {
            text-align: center;
            color: #1f2937;
            padding: 48px;
            border-radius: 32px;
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        }

        .audio-unlock-content h2 {
            margin: 20px 0 10px;
            font-size: 24px;
            background: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .audio-unlock-content p {
            margin-bottom: 24px;
            color: #4b5563;
        }
    </style>
</head>

<body>
    <div class="meeting-container">
        <!-- é ‚éƒ¨å·¥å…·åˆ— -->
        <header class="meeting-header">
            <div class="header-left">
                <h1><svg style="width:22px;height:22px;vertical-align:middle;margin-right:6px;" viewBox="0 0 24 24"
                        fill="none" stroke="#805ad5" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                        <line x1="12" y1="19" x2="12" y2="23" />
                        <line x1="8" y1="23" x2="16" y2="23" />
                    </svg>æœƒè­°å®¤ (å¤šäººæ¨¡å¼)</h1>
                <span id="participantCount" class="participant-count">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="header-right">
                <select id="languageSelect" class="language-select">
                    <option value="zh-TW">ä¸­æ–‡</option>
                    <option value="en-US">English</option>
                </select>
                <button id="speakerBtn" class="btn-secondary" title="å–‡å­"><svg style="width:18px;height:18px;"
                        viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
                    </svg></button>
                <button id="startBtn" class="btn-primary">é–‹å§‹éŒ„éŸ³</button>
                <button id="leaveBtn" class="btn-danger">é›¢é–‹æœƒè­°</button>
            </div>
        </header>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <main class="meeting-main">
            <!-- åƒèˆ‡è€…ç¶²æ ¼ -->
            <div id="participantGrid" class="participant-grid">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </main>

        <!-- éŸ³è¨Šè§£é–æç¤ºï¼ˆè§£æ±ºç€è¦½å™¨ autoplay æ”¿ç­–ï¼‰ -->
        <div id="audioUnlockOverlay" class="audio-unlock-overlay" style="display: none;">
            <div class="audio-unlock-content">
                <svg style="width:48px;height:48px;" viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2">
                    <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5" />
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07" />
                </svg>
                <h2>é»æ“Šå•Ÿç”¨èªéŸ³é€šè©±</h2>
                <p>ç€è¦½å™¨éœ€è¦æ‚¨çš„äº’å‹•æ‰èƒ½æ’­æ”¾éŸ³è¨Š</p>
                <button id="unlockAudioBtn" class="btn-primary" style="font-size: 18px; padding: 12px 32px;">
                    é»æ“Šå•Ÿç”¨
                </button>
            </div>
        </div>

        <!-- å­—å¹•æ¢ - å›ºå®šåœ¨åº•éƒ¨ -->
        <div class="caption-container" id="captionContainer">
            <div class="caption-header">
                <span>å³æ™‚å­—å¹•èˆ‡æ•¸æ“š</span>
                <button id="toggleExpand" class="btn-toggle">å±•é–‹å®Œæ•´è¦–åœ–</button>
            </div>
            <div class="caption-bar" id="captionBar">
                <!-- å­—å¹•é …ç›®å°‡æœƒåœ¨é€™è£¡å‹•æ…‹æ–°å¢ -->
            </div>
            <div id="captionFull" class="caption-full">
                <!-- å®Œæ•´å°è©±é¡¯ç¤º -->
            </div>
        </div>
    </div>

    <script>
        console.log('=== å¤šäººæœƒè­°å®¤åˆå§‹åŒ– ===');

        // å¾ URL å–å¾—æˆ¿é–“ ID
        const urlParams = new URLSearchParams(window.location.search);
        const MEETING_ID = urlParams.get('room') || 'main-room';
        console.log('æœƒè­°å®¤ ID:', MEETING_ID);

        // åˆå§‹åŒ– Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://inzqsdelrwxxlbcumaiw.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluenFzZGVscnd4eGxiY3VtYWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQzMjksImV4cCI6MjA4MzI5MDMyOX0.XBrMbxu_vcNQb55v6OZNoB-Mm1w-A2OtJk1AAgofjg0'
        );
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImluenFzZGVscnd4eGxiY3VtYWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3MTQzMjksImV4cCI6MjA4MzI5MDMyOX0.XBrMbxu_vcNQb55v6OZNoB-Mm1w-A2OtJk1AAgofjg0';


        let currentUser = null;
        let recognition = null;
        let isRecording = false;
        let isSpeaking = false;

        // --- èªéŸ³è½‰éŒ„å…¨åŸŸè®Šæ•¸ ---
        let audioContext = null;
        let audioStream = null;
        let processor = null;
        let socket = null;
        // ----------------------

        let participants = new Map();
        let participantsChannel = null;
        let captionsChannel = null;
        let roomWordBoost = []; // Word Boost é—œéµè©


        // æª¢æŸ¥æˆ¿é–“å­˜å–æ¬Šé™
        async function checkRoomAccess() {
            // å¦‚æœæ˜¯é è¨­æˆ¿é–“ï¼Œä¸æª¢æŸ¥æ¬Šé™
            if (MEETING_ID === 'main-room') {
                return true;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('room_access')
                    .select('*')
                    .eq('room_id', MEETING_ID)
                    .eq('email', currentUser.email)
                    .single();

                if (error || !data) {
                    alert('æ‚¨æ²’æœ‰æ¬Šé™é€²å…¥æ­¤æœƒè­°å®¤');
                    window.location.href = 'index.html';
                    return false;
                }

                console.log('âœ… æ¬Šé™é©—è­‰é€šé');
                return true;

            } catch (error) {
                console.error('æ¬Šé™æª¢æŸ¥å¤±æ•—:', error);
                alert('æ¬Šé™æª¢æŸ¥å¤±æ•—');
                window.location.href = 'index.html';
                return false;
            }
        }

        // ç«‹å³æª¢æŸ¥ç™»å…¥ç‹€æ…‹ï¼ˆåœ¨é é¢è¼‰å…¥æ™‚ï¼‰
        (async function checkAuthImmediately() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                console.log('âŒ æœªç™»å…¥ï¼Œè·³è½‰åˆ°é¦–é ');
                alert('è«‹å…ˆç™»å…¥');
                window.location.href = 'index.html';
                return;
            }
            console.log('âœ… å·²ç™»å…¥ï¼Œç¹¼çºŒè¼‰å…¥æœƒè­°å®¤');
        })();

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹ä¸¦åŠ å…¥æœƒè­°
        supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
            if (!session) {
                window.location.href = 'index.html';
                return;
            }

            currentUser = session.user;
            console.log('âœ… ä½¿ç”¨è€…å·²ç™»å…¥', currentUser.email);

            // æª¢æŸ¥æˆ¿é–“æ¬Šé™
            const hasAccess = await checkRoomAccess();
            if (!hasAccess) return;

            // åŠ å…¥æœƒè­°å®¤
            await joinMeeting();

            // è¨‚é–±åƒèˆ‡è€…è®ŠåŒ–
            subscribeToParticipants();

            // è¨‚é–±å­—å¹•
            subscribeToCaptions();

            // åˆå§‹åŒ–èªéŸ³è­˜åˆ¥
            initSpeechRecognition();

            // è¼‰å…¥ç¾æœ‰åƒèˆ‡è€…
            await loadParticipants();

            // è¼‰å…¥ Word Boost é—œéµè©
            await loadRoomWordBoost();
        });

        // åŠ å…¥æœƒè­°å®¤
        async function joinMeeting() {
            try {
                const { error } = await supabaseClient
                    .from('participants')
                    .upsert({
                        meeting_id: MEETING_ID,
                        user_id: currentUser.id,
                        user_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                        photo_url: currentUser.user_metadata?.avatar_url,
                        status: 'online',
                        is_speaking: false
                    }, {
                        onConflict: 'meeting_id,user_id'
                    });

                if (error) throw error;
                console.log('âœ… å·²åŠ å…¥æœƒè­°å®¤');
            } catch (error) {
                console.error('åŠ å…¥æœƒè­°å¤±æ•—:', error);
            }
        }

        // è¨‚é–±åƒèˆ‡è€…è®ŠåŒ–
        function subscribeToParticipants() {
            participantsChannel = supabaseClient
                .channel('participants-changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'participants',
                    filter: `meeting_id=eq.${MEETING_ID}`
                }, (payload) => {
                    console.log('åƒèˆ‡è€…è®ŠåŒ–:', payload);
                    loadParticipants();
                })
                .subscribe();
        }

        // è¨‚é–±å­—å¹•
        function subscribeToCaptions() {
            console.log('ğŸ”” è¨­å®šå­—å¹•è¨‚é–±ï¼Œæœƒè­°å®¤:', MEETING_ID);
            captionsChannel = supabaseClient
                .channel('captions-changes')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'captions'
                }, (payload) => {
                    console.log('ğŸ“ æ”¶åˆ°å­—å¹•äº‹ä»¶:', payload.new);
                    // åªé¡¯ç¤ºç•¶å‰æœƒè­°å®¤çš„å­—å¹•ï¼Œä¸”å¿½ç•¥è‡ªå·±çš„ï¼ˆé¿å…é‡è¤‡é¡¯ç¤ºï¼‰
                    if (payload.new.meeting_id === MEETING_ID &&
                        payload.new.user_id !== currentUser?.id) {
                        displayRemoteCaption(payload.new);
                    }
                })
                .subscribe((status) => {
                    console.log('ğŸ”Œ å­—å¹•è¨‚é–±ç‹€æ…‹:', status);
                });
        }

        // å·²ç§»é™¤èˆŠæœ‰çš„å…¨å±€ showDataSnapshot å‡½æ•¸
        function getNumericalTags(text) {
            if (!text) return [];
            // åŒ¹é…æ•¸å­—ä»¥åŠå¯èƒ½å‰å¾Œè·Ÿéš¨çš„å–®ä½
            // 1. å¸¶å–®ä½çš„æ•¸å­— (å¦‚ $50, 0.75ç¾é‡‘, 100%, 60æ¬¡)
            const unitRegex = /(?:[$Â¥â‚¬]|ç¾é‡‘|è‹±éŠ|æ­å…ƒ|æ¬¡|å€‹|å°å¹£|HKD|USD)?\s*\d+(?:[.]\d+)*\s*(?:[%$Â¥â‚¬\u4e00-\u9fa5A-Z]{1,4})?/gi;
            // 2. å°æ•¸ (å¦‚ 0.000075, .000075)
            const decimalRegex = /[0-9]*[.][0-9]+/g;

            let matches = text.match(unitRegex) || [];
            const decimals = text.match(decimalRegex) || [];
            matches = [...new Set([...matches, ...decimals])];

            return matches.map(m => m.trim()).filter(m => {
                const hasUnit = /[$Â¥â‚¬%æ¬¡å€‹\u4e00-\u9fa5A-Z]/.test(m);
                const hasDot = /[.]/.test(m);
                const isLongNum = m.replace(/[^0-9]/g, '').length >= 3;
                return hasUnit || hasDot || isLongNum;
            });
        }

        // --- ç›¸å®¹æ€§è£œä¸ï¼šé¿å…èˆŠç¨‹å¼ç¢¼å‘¼å« addCaption å°è‡´å´©æ½° ---
        function addCaption(speaker, text, isFinal = true) {
            console.log('ğŸ”„ å‘¼å«ç›¸å®¹å±¤ addCaption:', speaker, text);
            if (isFinal) {
                const tags = getNumericalTags(text);
                showLocalCaption(text, tags);
                saveCaption(text, true);
            } else {
                showInterimCaption(text);
            }
        }

        // è¼‰å…¥åƒèˆ‡è€…åˆ—è¡¨
        async function loadParticipants() {
            try {
                const { data, error } = await supabaseClient
                    .from('participants')
                    .select('*')
                    .eq('meeting_id', MEETING_ID)
                    .eq('status', 'online');

                if (error) throw error;

                participants.clear();
                data.forEach(p => participants.set(p.user_id, p));

                updateParticipantGrid();
                updateParticipantCount();
            } catch (error) {
                console.error('è¼‰å…¥åƒèˆ‡è€…å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥ Word Boost é—œéµè©
        async function loadRoomWordBoost() {
            // é è¨­æˆ¿é–“ä¸è¼‰å…¥
            if (MEETING_ID === 'main-room') return;

            try {
                const { data: room, error } = await supabaseClient
                    .from('rooms')
                    .select('word_boost')
                    .eq('room_id', MEETING_ID)
                    .single();

                if (error) throw error;

                if (room && room.word_boost && room.word_boost.length > 0) {
                    roomWordBoost = room.word_boost;
                    console.log('ğŸ¯ å·²è¼‰å…¥ Word Boost é—œéµè©:', roomWordBoost.length, 'å€‹');
                }
            } catch (error) {
                console.error('è¼‰å…¥ Word Boost å¤±æ•—:', error);
            }
        }

        // æ›´æ–°åƒèˆ‡è€…ç¶²æ ¼
        function updateParticipantGrid() {
            const grid = document.getElementById('participantGrid');
            grid.innerHTML = '';

            // è¨­å®š data-count å±¬æ€§ä¾› CSS ä½¿ç”¨
            grid.setAttribute('data-count', participants.size);

            participants.forEach((participant, userId) => {
                const isMe = userId === currentUser.id;
                const card = document.createElement('div');
                card.className = 'participant-card';
                card.id = `participant-${userId}`;

                if (participant.is_speaking) {
                    card.classList.add('speaking');
                }

                card.innerHTML = `
                    <div class="participant-photo">
                        ${participant.photo_url
                        ? `<img src="${participant.photo_url}" alt="${participant.user_name}">`
                        : `<div class="photo-placeholder">${participant.user_name.charAt(0).toUpperCase()}</div>`
                    }
                        <div class="participant-name">${participant.user_name}${isMe ? ' (æˆ‘)' : ''}</div>
                    </div>
                `;

                grid.appendChild(card);
            });
        }

        // æ›´æ–°åƒèˆ‡è€…è¨ˆæ•¸
        function updateParticipantCount() {
            document.getElementById('participantCount').textContent = `${participants.size} äºº`;
        }





        // API è¨­å®š
        const ASSEMBLYAI_URL = 'https://inzqsdelrwxxlbcumaiw.supabase.co/functions/v1/assemblyai-speech';
        const DEEPGRAM_URL = 'https://inzqsdelrwxxlbcumaiw.supabase.co/functions/v1/deepgram-speech';

        let mediaRecorder = null;
        let recordingInterval = null;
        let audioChunks = [];

        // é–‹å§‹ AssemblyAI Batch éŒ„éŸ³
        async function startAssemblyAIBatch() {
            try {
                // å„ªå…ˆä½¿ç”¨ç¾æœ‰éº¥å…‹é¢¨ä¸²æµ
                let streamToUse = localStream;
                if (!streamToUse || !streamToUse.active) {
                    console.log('ğŸ¤ è«‹æ±‚æ–°çš„éº¥å…‹é¢¨æ¬Šé™ (Batch Mode)');
                    streamToUse = await navigator.mediaDevices.getUserMedia({
                        audio: { echoCancellation: true, noiseSuppression: true }
                    });
                    audioStream = streamToUse;
                } else {
                    console.log('ğŸ¤ é‡ç”¨ç¾æœ‰éº¥å…‹é¢¨ä¸²æµ (Batch Mode)');
                }

                console.log('âœ… AssemblyAI Batch èªéŸ³è½‰éŒ„å·²å•Ÿå‹•');
                showInterimCaption('æ­£åœ¨è†è½ (æ¯ 30 ç§’è¾¨è­˜ä¸€æ¬¡)...');

                // âš ï¸ é‡è¦ï¼šå…ˆè¨­å®š isRecordingï¼Œå†å•Ÿå‹•éŒ„éŸ³å¾ªç’°
                isRecording = true;

                // å•Ÿå‹•éŒ„éŸ³å¾ªç’°
                startRecordingLoop(streamToUse);
                return true;

            } catch (error) {
                console.error('èªéŸ³è¾¨è­˜åˆå§‹åŒ–å¤±æ•—:', error);
                alert('èªéŸ³è¾¨è­˜åˆå§‹åŒ–å¤±æ•—ï¼š' + error.message);
                return false;
            }
        }

        // éŒ„éŸ³å¾ªç’° - ç„¡ç¸«éŒ„éŸ³ç‰ˆ
        function startRecordingLoop(stream) {
            console.log('ğŸ”„ startRecordingLoop è¢«èª¿ç”¨, isRecording =', isRecording);
            const language = document.getElementById('languageSelect').value;

            function recordNextChunk() {
                console.log('ğŸ™ï¸ recordNextChunk è¢«èª¿ç”¨, isRecording =', isRecording);
                if (!isRecording) {
                    console.log('âš ï¸ isRecording ç‚º falseï¼Œé€€å‡ºéŒ„éŸ³');
                    return;
                }

                audioChunks = [];

                try {
                    mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });
                    console.log('âœ… MediaRecorder å‰µå»ºæˆåŠŸ (opus)');
                } catch (e) {
                    console.log('âš ï¸ opus ä¸æ”¯æ´ï¼Œä½¿ç”¨é è¨­æ ¼å¼');
                    mediaRecorder = new MediaRecorder(stream);
                }

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        console.log('ğŸ“¥ æ”¶åˆ°éŸ³è¨Šæ•¸æ“š:', event.data.size, 'bytes');
                    }
                };

                mediaRecorder.onstop = async () => {
                    console.log('â¹ï¸ MediaRecorder åœæ­¢ï¼ŒaudioChunks.length =', audioChunks.length);

                    // âš ï¸ é—œéµä¿®æ­£ï¼šå…ˆä¿å­˜ç•¶å‰çš„ chunksï¼Œå†é–‹å§‹ä¸‹ä¸€è¼ª
                    const chunksToProcess = [...audioChunks]; // è¤‡è£½ä¸€ä»½

                    // é¦¬ä¸Šé–‹å§‹ä¸‹ä¸€æ®µï¼ŒæŠŠç©ºçª—æœŸç¸®åˆ°æœ€å°
                    if (isRecording) {
                        recordNextChunk();
                    }

                    // ç”¨ä¿å­˜çš„ chunks ä¾†è™•ç†ï¼ˆä¸æœƒè¢«æ–°éŒ„éŸ³è¦†è“‹ï¼‰
                    if (chunksToProcess.length === 0) return;

                    const audioBlob = new Blob(chunksToProcess, { type: 'audio/webm' });
                    console.log('ğŸ“¦ æº–å‚™ä¸Šå‚³ Blob:', audioBlob.size, 'bytes');
                    if (audioBlob.size < 1000) return;

                    // éåŒæ­¥ä¸Šå‚³ï¼Œä¸é˜»æ“‹éŒ„éŸ³
                    processAudioChunk(audioBlob, language);
                };

                mediaRecorder.start();
                console.log('â–¶ï¸ MediaRecorder é–‹å§‹éŒ„éŸ³');

                // 20ç§’å¾Œåœæ­¢é€™ä¸€æ®µ -> è§¸ç™¼ onstop -> ç«‹å³é–‹å§‹ä¸‹ä¸€æ®µ
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        console.log('â° 20ç§’åˆ°ï¼Œåœæ­¢éŒ„éŸ³');
                        mediaRecorder.stop();
                    }
                }, 20000);
            }

            // å•Ÿå‹•ç¬¬ä¸€æ¬¡
            console.log('ğŸš€ å³å°‡å•Ÿå‹•ç¬¬ä¸€æ¬¡ recordNextChunk');
            recordNextChunk();
        }

        async function processAudioChunk(audioBlob, language) {
            const reader = new FileReader();
            reader.onloadend = async () => {
                const base64Audio = reader.result.split(',')[1];
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (!session) return;

                    console.log('ğŸ“¤ åŒæ­¥å‘¼å« AssemblyAI èˆ‡ Deepgram...');

                    // 1. å‘¼å« AssemblyAI (ä¸»æ–‡å­—)
                    const assemblyRequest = fetch(ASSEMBLYAI_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            audio: base64Audio,
                            language: language,
                            roomId: MEETING_ID,
                            wordBoost: roomWordBoost
                        })
                    }).then(res => res.json()).catch(err => ({ error: 'AssemblyAI å‘¼å«å¤±æ•—: ' + err.message }));

                    // 2. å‘¼å« Deepgram (æ•¸å­—è¼”åŠ©)
                    const deepgramRequest = fetch(DEEPGRAM_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${session.access_token}`
                        },
                        body: JSON.stringify({
                            audio: base64Audio,
                            language: language,
                            roomId: MEETING_ID
                        })
                    }).then(res => res.json()).catch(err => ({ error: 'Deepgram å‘¼å«å¤±æ•—: ' + err.message }));

                    // ä¸¦è¡Œå–å¾—çµæœ
                    const [aaiResult, dgResult] = await Promise.all([assemblyRequest, deepgramRequest]);

                    if (dgResult.error) console.warn('âš ï¸ Deepgram éŒ¯èª¤:', dgResult.error);
                    else console.log('ğŸ¯ Deepgram è¾¨è­˜æˆåŠŸ:', dgResult.transcript);

                    if (aaiResult.error) console.error('âŒ AssemblyAI éŒ¯èª¤:', aaiResult.error);
                    else console.log('ğŸ“ AssemblyAI è¾¨è­˜æˆåŠŸ:', aaiResult.transcript);

                    // è™•ç† Deepgram (æ•¸å­—æå–)
                    let numericalTags = [];
                    if (dgResult && dgResult.transcript) {
                        numericalTags = getNumericalTags(dgResult.transcript);
                    }

                    // è™•ç† AssemblyAI (ä¸»å­—å¹•)
                    if (aaiResult && aaiResult.transcript && aaiResult.transcript.trim()) {
                        const processedText = await addPunctuation(aaiResult.transcript);
                        showLocalCaption(processedText, numericalTags);
                        saveCaption(processedText, true);
                    }

                } catch (error) {
                    console.error('éŸ³é¢‘è™•ç†é‚è¼¯é‡å¤§éŒ¯èª¤:', error);
                }
            };
            reader.readAsDataURL(audioBlob);
        }

        // æå–æ•¸å­—ä¸¦é¡¯ç¤ºå¿«ç…§
        function extractAndShowNumbers(text) {
            // é€™å€‹å‡½æ•¸å·²æ£„ç”¨ï¼Œæ•¸å­—æ¨™ç±¤ç¾åœ¨ç›´æ¥éŠœæ¥åœ¨å­—å¹•å…§å®¹ä¸­ã€‚
        }

        function stopAssemblyAIBatch() {
            console.log('â¹ï¸ åœæ­¢ AssemblyAI (Batch)...');
            if (recordingInterval) {
                clearInterval(recordingInterval);
                recordingInterval = null;
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            console.log('âœ… Batch éŒ„éŸ³å·²åœæ­¢');
        }


        // ========== PeerJS èªéŸ³é€šè©± ==========
        let peer = null;
        let localStream = null;
        let voiceChannel = null;
        let peerConnections = new Map();
        let isMicOn = true;
        let isSpeakerOn = true;

        async function initPeerVoice() {
            try {
                console.log('ğŸ“± é–‹å§‹åˆå§‹åŒ– PeerJS...');

                // å–å¾—éº¥å…‹é¢¨æ¬Šé™
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                console.log('âœ… å–å¾—éº¥å…‹é¢¨æ¬Šé™');

                // âš ï¸ é è¨­é—œé–‰éº¥å…‹é¢¨ï¼Œç­‰ä½¿ç”¨è€…æŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€æ‰é–‹å•Ÿ
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = false;
                });
                isMicOn = false;
                console.log('ğŸ”‡ éº¥å…‹é¢¨é è¨­é—œé–‰ï¼ŒæŒ‰ã€Œé–‹å§‹éŒ„éŸ³ã€æ‰æœƒé–‹å•Ÿ');

                // å»ºç«‹ PeerJS é€£æ¥ï¼ˆåŠ å…¥ STUN ä¼ºæœå™¨ä»¥æ”¹å–„æ‰‹æ©Ÿé€£æ¥ï¼‰
                const peerId = `${MEETING_ID}-${currentUser.id.substring(0, 8)}`;
                peer = new Peer(peerId, {
                    debug: 2,  // æé«˜é™¤éŒ¯ç­‰ç´š
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    console.log('âœ… PeerJS é€£æ¥æˆåŠŸ, ID:', id);
                    broadcastPeerId(id);

                    // ğŸ”„ å¿ƒè·³æ©Ÿåˆ¶ï¼šæ¯ 25 ç§’ ping ä¸€æ¬¡ä¿æŒé€£ç·š
                    if (window.peerHeartbeat) clearInterval(window.peerHeartbeat);
                    window.peerHeartbeat = setInterval(() => {
                        if (peer && !peer.destroyed && peer.open) {
                            // PeerJS æ²’æœ‰å…¬é–‹çš„ heartbeat APIï¼Œç”¨ socket ç‹€æ…‹æª¢æŸ¥ä»£æ›¿
                            console.log('ğŸ’“ PeerJS å¿ƒè·³æª¢æŸ¥ - é€£ç·šç‹€æ…‹:', peer.open ? 'æ­£å¸¸' : 'ä¸­æ–·');
                        }
                    }, 25000);
                });

                peer.on('call', (call) => {
                    console.log('ğŸ“ æ”¶åˆ°ä¾†é›»:', call.peer);
                    console.log('ğŸ“ æœ¬åœ°éŸ³è¨Šè»Œé“æ•¸:', localStream.getAudioTracks().length);
                    call.answer(localStream);
                    handleCall(call);
                });

                peer.on('error', (err) => {
                    console.error('âŒ PeerJS éŒ¯èª¤:', err.type, err);
                    // åªåœ¨éç¶²è·¯éŒ¯èª¤æ™‚é¡¯ç¤º alert
                    if (err.type !== 'network' && err.type !== 'disconnected') {
                        alert('èªéŸ³é€£ç·šéŒ¯èª¤: ' + err.type);
                    }
                });

                peer.on('disconnected', () => {
                    console.warn('âš ï¸ PeerJS é€£ç·šä¸­æ–·ï¼Œå˜—è©¦é‡é€£...');
                    // æ¸…é™¤å¿ƒè·³
                    if (window.peerHeartbeat) {
                        clearInterval(window.peerHeartbeat);
                        window.peerHeartbeat = null;
                    }
                    // å»¶é²é‡é€£ï¼Œé¿å…éæ–¼é »ç¹
                    setTimeout(() => {
                        if (peer && !peer.destroyed) {
                            peer.reconnect();
                        }
                    }, 1000);
                });

                updateVoiceButtons();

            } catch (error) {
                console.error('âŒ PeerJS åˆå§‹åŒ–å¤±æ•—:', error);
                alert('èªéŸ³åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }

        function handleCall(call) {
            call.on('stream', (remoteStream) => {
                console.log('ğŸµ æ”¶åˆ°é ç«¯éŸ³è¨Š:', call.peer);
                playRemoteAudio(remoteStream, call.peer);
            });

            call.on('close', () => {
                console.log('ğŸ“´ é€šè©±çµæŸ:', call.peer);
                removeRemoteAudio(call.peer);
                peerConnections.delete(call.peer);
            });

            peerConnections.set(call.peer, call);
        }

        function playRemoteAudio(stream, peerId) {
            let audio = document.getElementById(`audio-${peerId}`);
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = `audio-${peerId}`;
                audio.autoplay = true;
                audio.playsInline = true;
                audio.setAttribute('playsinline', '');  // iOS éœ€è¦
                audio.setAttribute('webkit-playsinline', '');  // èˆŠç‰ˆ iOS
                audio.style.display = 'none';
                document.body.appendChild(audio);
            }
            audio.srcObject = stream;
            audio.muted = !isSpeakerOn;
            audio.volume = 1.0;  // ç¢ºä¿éŸ³é‡æœ€å¤§

            // æ‰‹æ©Ÿ+é›»è…¦é€šç”¨çš„æ’­æ”¾å˜—è©¦
            const tryPlay = () => {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('ğŸ”Š éŸ³è¨Šæ’­æ”¾æˆåŠŸ:', peerId);
                    }).catch(err => {
                        console.warn('âš ï¸ éŸ³è¨Šæ’­æ”¾è¢«é˜»æ“‹:', err.name);
                        // è¨»å†Šå¤šç¨®äº’å‹•äº‹ä»¶
                        const resumeAudio = () => {
                            audio.muted = false;
                            audio.volume = 1.0;
                            audio.play().then(() => {
                                console.log('ğŸ”Š é‡è©¦æ’­æ”¾æˆåŠŸ');
                            }).catch(e => console.error('é‡è©¦æ’­æ”¾å¤±æ•—:', e));
                        };
                        // æ‰‹æ©Ÿéœ€è¦ touchstart/touchend
                        ['click', 'touchstart', 'touchend', 'keydown'].forEach(event => {
                            document.addEventListener(event, resumeAudio, { once: true });
                        });
                    });
                }
            };

            // å»¶é²æ’­æ”¾ï¼ˆæŸäº›æ‰‹æ©Ÿéœ€è¦ï¼‰
            setTimeout(tryPlay, 100);
        }

        function removeRemoteAudio(peerId) {
            const audio = document.getElementById(`audio-${peerId}`);
            if (audio) audio.remove();
        }

        async function broadcastPeerId(peerId) {
            voiceChannel = supabaseClient.channel(`voice-${MEETING_ID}`);

            voiceChannel.on('broadcast', { event: 'peer-join' }, async (payload) => {
                const remotePeerId = payload.payload.peerId;
                if (remotePeerId !== peerId && !peerConnections.has(remotePeerId)) {
                    console.log('ğŸ“ æ’¥æ‰“çµ¦:', remotePeerId);
                    const call = peer.call(remotePeerId, localStream);
                    handleCall(call);
                }
            });

            await voiceChannel.subscribe();

            voiceChannel.send({
                type: 'broadcast',
                event: 'peer-join',
                payload: { peerId }
            });
        }

        function updateVoiceButtons() {
            const micBtn = document.getElementById('micBtn');
            const speakerBtn = document.getElementById('speakerBtn');

            const speakerOnSvg = '<svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
            const speakerOffSvg = '<svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
            const micOnSvg = '<svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg>';
            const micOffSvg = '<svg style="width:18px;height:18px;" viewBox="0 0 24 24" fill="none" stroke="#805ad5" stroke-width="2"><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12M15 9.34V4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2m14 0v2a7 7 0 0 1-.11 1.23"/></svg>';

            if (micBtn) {
                micBtn.innerHTML = isMicOn ? micOnSvg : micOffSvg;
                micBtn.style.opacity = isMicOn ? '1' : '0.5';
            }
            if (speakerBtn) {
                speakerBtn.innerHTML = isSpeakerOn ? speakerOnSvg : speakerOffSvg;
                speakerBtn.style.opacity = isSpeakerOn ? '1' : '0.5';
            }
        }

        function toggleMic() {
            isMicOn = !isMicOn;
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = isMicOn;
                });
            }
            updateVoiceButtons();
            console.log('ğŸ™ï¸ éº¥å…‹é¢¨:', isMicOn ? 'é–‹å•Ÿ' : 'é—œé–‰');
        }

        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn;
            document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                audio.muted = !isSpeakerOn;
            });
            updateVoiceButtons();
            console.log('ğŸ”Š å–‡å­:', isSpeakerOn ? 'é–‹å•Ÿ' : 'é—œé–‰');
        }

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è­˜åˆ¥åŠŸèƒ½ã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚');
                return;
            }

            const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognitionAPI();

            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 3;
            recognition.lang = 'zh-TW';

            let finalTranscriptBuffer = '';
            let lastFinalTime = Date.now();

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (interimTranscript) {
                    showInterimCaption(interimTranscript);
                }

                if (finalTranscript) {
                    finalTranscriptBuffer += finalTranscript + ' ';
                    lastFinalTime = Date.now();

                    // ç«‹å³é¡¯ç¤ºæœ¬åœ°å­—å¹•ï¼ˆä¸ç­‰è³‡æ–™åº«ï¼‰
                    showLocalCaption(finalTranscript);

                    // æ¸›å°‘å»¶é²ï¼Œæ›´å¿«å„²å­˜
                    setTimeout(() => {
                        if (Date.now() - lastFinalTime >= 500 && finalTranscriptBuffer.trim()) {
                            saveCaption(finalTranscriptBuffer.trim());
                            finalTranscriptBuffer = '';
                        }
                    }, 600);
                }
            };

            let isRestarting = false;

            recognition.onerror = (event) => {
                console.error('èªéŸ³è­˜åˆ¥éŒ¯èª¤:', event.error);

                // åš´é‡éŒ¯èª¤ï¼Œåœæ­¢éŒ„éŸ³
                if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                    alert('ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®š');
                    stopRecording();
                    return;
                }

                // å¯æ¢å¾©çš„éŒ¯èª¤ï¼Œå˜—è©¦é‡å•Ÿ
                if ((event.error === 'no-speech' || event.error === 'aborted' || event.error === 'network') && isRecording && !isRestarting) {
                    isRestarting = true;
                    setTimeout(() => {
                        if (isRecording) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('é‡å•Ÿå¤±æ•—:', e);
                            }
                        }
                        isRestarting = false;
                    }, 300);
                }
            };

            recognition.onend = () => {
                console.log('èªéŸ³è­˜åˆ¥çµæŸ');
                if (isRecording && !isRestarting) {
                    isRestarting = true;
                    setTimeout(() => {
                        if (isRecording) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('é‡å•Ÿå¤±æ•—:', e);
                            }
                        }
                        isRestarting = false;
                    }, 300);
                }
            };

            console.log('âœ… èªéŸ³è­˜åˆ¥å·²åˆå§‹åŒ–');
        }

        // åˆå§‹åŒ–èªªè©±è€…æª¢æ¸¬
        async function initSpeakerDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;

                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);

                detectSpeaking();
                console.log('âœ… èªªè©±è€…æª¢æ¸¬å·²åˆå§‹åŒ–');
                return true;
            } catch (error) {
                console.error('ç„¡æ³•å­˜å–éº¥å…‹é¢¨:', error);
                return false;
            }
        }

        // æª¢æ¸¬èªªè©±
        function detectSpeaking() {
            if (!analyser) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;

            const speaking = average > 25;
            if (speaking !== isSpeaking) {
                isSpeaking = speaking;
                updateSpeakingStatus(speaking);
            }

            animationId = requestAnimationFrame(detectSpeaking);
        }

        // æ›´æ–°èªªè©±ç‹€æ…‹
        async function updateSpeakingStatus(speaking) {
            const card = document.getElementById(`participant-${currentUser.id}`);
            if (card) {
                if (speaking) {
                    card.classList.add('speaking');
                } else {
                    card.classList.remove('speaking');
                }
            }

            // æ›´æ–°è³‡æ–™åº«
            try {
                await supabaseClient
                    .from('participants')
                    .update({ is_speaking: speaking })
                    .eq('meeting_id', MEETING_ID)
                    .eq('user_id', currentUser.id);
            } catch (error) {
                console.error('æ›´æ–°èªªè©±ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºå³æ™‚å­—å¹•ï¼ˆæœ¬åœ°ï¼‰
        function showInterimCaption(text) {
            const captionBar = document.getElementById('captionBar');
            // ä½¿ç”¨ user_id ä¾†å€åˆ†ä¸åŒä½¿ç”¨è€…çš„å³æ™‚å­—å¹•
            const interimId = `interim-${currentUser.id}`;
            let interimEl = captionBar.querySelector(`#${interimId}`);

            if (!interimEl) {
                interimEl = document.createElement('div');
                interimEl.id = interimId;
                interimEl.className = 'caption-item interim-caption';
                interimEl.style.opacity = '0.5';
                captionBar.appendChild(interimEl);
            }

            const userName = currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'æˆ‘';
            interimEl.innerHTML = `
                <span class="caption-speaker">${userName}:</span>
                <span class="caption-text">${escapeHtml(text)}</span>
            `;

            captionBar.scrollTop = captionBar.scrollHeight;
        }

        // ç«‹å³é¡¯ç¤ºæœ¬åœ°ç¢ºå®šå­—å¹•ï¼ˆä¸ç­‰è³‡æ–™åº«ï¼‰
        function showLocalCaption(text, tags = []) {
            const captionBar = document.getElementById('captionBar');
            const captionFull = document.getElementById('captionFull');

            // ç§»é™¤å³æ™‚å­—å¹•
            const interimId = `interim-${currentUser.id}`;
            const interimEl = captionBar.querySelector(`#${interimId}`);
            if (interimEl) interimEl.remove();

            const userName = currentUser?.user_metadata?.full_name || currentUser?.email?.split('@')[0] || 'æˆ‘';
            const now = new Date().toLocaleTimeString('zh-TW');

            // ç”¢ç”Ÿæ¨™ç±¤ HTML
            const tagsHtml = tags.length > 0 ?
                `<div class="caption-tags">${tags.map(t => `<span class="caption-tag" title="Deepgram åµæ¸¬åˆ°çš„æ•¸æ“š">${t}</span>`).join('')}</div>` : '';

            // å­—å¹•æ¢
            const captionItem = document.createElement('div');
            captionItem.className = 'caption-item';
            captionItem.style.opacity = '0.7';
            captionItem.innerHTML = `
                <span class="caption-speaker">${userName}:</span>
                <span class="caption-text">${escapeHtml(text)}</span>
                ${tagsHtml}
            `;
            captionBar.appendChild(captionItem);

            // åªä¿ç•™æœ€è¿‘ 3 è¡Œ
            const items = captionBar.querySelectorAll('.caption-item:not(.interim-caption)');
            if (items.length > 3) {
                for (let i = 0; i < items.length - 3; i++) {
                    items[i].remove();
                }
            }

            // å®Œæ•´å­—å¹•
            const captionFullItem = document.createElement('div');
            captionFullItem.className = 'caption-item-full';
            captionFullItem.innerHTML = `
                <div class="caption-header">
                    <span class="caption-speaker">${userName}</span>
                    <span class="caption-time">${now}</span>
                </div>
                <div class="caption-text">${escapeHtml(text)}</div>
                ${tagsHtml}
            `;
            captionFull.appendChild(captionFullItem);

            captionBar.scrollTop = captionBar.scrollHeight;
            captionFull.scrollTop = captionFull.scrollHeight;
        }

        // ä½¿ç”¨ OpenRouter AI æ·»åŠ æ¨™é»ç¬¦è™Ÿå’Œä¿®æ­£éŒ¯åˆ¥å­—
        const PUNCTUATION_API_URL = 'https://inzqsdelrwxxlbcumaiw.supabase.co/functions/v1/rapid-action';

        async function addPunctuation(text) {
            try {
                const response = await fetch(PUNCTUATION_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        mode: 'punctuation',
                        conversationText: text
                    })
                });

                if (!response.ok) {
                    console.warn('AI è™•ç†å¤±æ•—ï¼Œä½¿ç”¨åŸæ–‡');
                    return text;
                }

                const data = await response.json();
                return data.text || data.summary || text;
            } catch (error) {
                console.warn('AI è™•ç†éŒ¯èª¤:', error);
                return text;
            }
        }

        // å„²å­˜å­—å¹•åˆ°è³‡æ–™åº«ï¼ˆèƒŒæ™¯åŸ·è¡Œï¼Œä¸é˜»å¡ï¼‰
        async function saveCaption(text, alreadyProcessed = false) {
            try {
                let finalText = text;

                // å¦‚æœå°šæœªè™•ç†éï¼Œæ‰å‘¼å« AI åŠ æ¨™é»
                if (!alreadyProcessed) {
                    try {
                        finalText = await addPunctuation(text);
                        if (finalText !== text) {
                            console.log('ğŸ“ AI è™•ç†å¾Œ:', finalText);
                        }
                    } catch (e) {
                        console.warn('AI è™•ç†è·³é');
                    }
                }

                // éåŒæ­¥å„²å­˜ï¼Œä¸ç­‰å¾…çµæœ
                supabaseClient
                    .from('captions')
                    .insert({
                        meeting_id: MEETING_ID,
                        user_id: currentUser.id,
                        user_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                        text: finalText,
                        language: document.getElementById('languageSelect').value
                    })
                    .then(({ error }) => {
                        if (error) console.error('å„²å­˜å­—å¹•å¤±æ•—:', error);
                        else console.log('âœ… å­—å¹•å·²å„²å­˜');
                    });
            } catch (error) {
                console.error('å„²å­˜å­—å¹•å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºé ç«¯å­—å¹•
        function displayRemoteCaption(caption) {
            const captionBar = document.getElementById('captionBar');
            const captionFull = document.getElementById('captionFull');

            // ç§»é™¤å°æ‡‰ä½¿ç”¨è€…çš„å³æ™‚å­—å¹•
            const interimId = `interim-${caption.user_id}`;
            const interimEl = captionBar.querySelector(`#${interimId}`);
            if (interimEl) interimEl.remove();

            const now = new Date(caption.created_at).toLocaleTimeString('zh-TW');

            // å­—å¹•æ¢ï¼šåªä¿ç•™æœ€è¿‘ 3 è¡Œ
            const captionItem = document.createElement('div');
            captionItem.className = 'caption-item';
            captionItem.innerHTML = `
                <span class="caption-speaker">${caption.user_name}:</span>
                <span class="caption-text">${escapeHtml(caption.text)}</span>
            `;
            captionBar.appendChild(captionItem);

            // åªä¿ç•™æœ€è¿‘ 3 è¡Œ
            const items = captionBar.querySelectorAll('.caption-item:not(.interim-caption)');
            if (items.length > 3) {
                for (let i = 0; i < items.length - 3; i++) {
                    items[i].remove();
                }
            }

            // å®Œæ•´å­—å¹•ï¼šä¿ç•™æ‰€æœ‰
            const captionFullItem = document.createElement('div');
            captionFullItem.className = 'caption-item-full';
            captionFullItem.innerHTML = `
                <div class="caption-header">
                    <span class="caption-speaker">${caption.user_name}</span>
                    <span class="caption-time">${now}</span>
                </div>
                <div class="caption-text">${escapeHtml(caption.text)}</div>
            `;
            captionFull.appendChild(captionFullItem);

            captionBar.scrollTop = captionBar.scrollHeight;
            captionFull.scrollTop = captionFull.scrollHeight;
        }

        // HTML è½‰ç¾©
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // åœæ­¢éŒ„éŸ³
        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('åœæ­¢èªéŸ³è­˜åˆ¥å¤±æ•—:', e);
                }
            }
            if (typeof animationId !== 'undefined' && animationId) cancelAnimationFrame(animationId);
            if (audioContext) {
                try {
                    audioContext.close();
                } catch (e) {
                    console.error('é—œé–‰éŸ³è¨Šä¸Šä¸‹æ–‡å¤±æ•—:', e);
                }
            }
            isRecording = false;
            isSpeaking = false;
            updateSpeakingStatus(false);
            document.getElementById('startBtn').textContent = 'é–‹å§‹éŒ„éŸ³';
            document.getElementById('startBtn').classList.remove('btn-danger');
            document.getElementById('startBtn').classList.add('btn-primary');
        }

        // é›¢é–‹æœƒè­°
        async function leaveMeeting() {
            try {
                await supabaseClient
                    .from('participants')
                    .delete()
                    .eq('meeting_id', MEETING_ID)
                    .eq('user_id', currentUser.id);

                if (participantsChannel) participantsChannel.unsubscribe();
                if (captionsChannel) captionsChannel.unsubscribe();

                // æ–·é–‹ PeerJS èªéŸ³
                if (peer) {
                    peerConnections.forEach(call => call.close());
                    peerConnections.clear();
                    peer.destroy();
                    peer = null;
                }
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }
                if (voiceChannel) {
                    voiceChannel.unsubscribe();
                    voiceChannel = null;
                }
                // ç§»é™¤æ‰€æœ‰é ç«¯éŸ³è¨Šå…ƒç´ 
                document.querySelectorAll('audio[id^="audio-"]').forEach(el => el.remove());

                console.log('âœ… å·²é›¢é–‹æœƒè­°');
            } catch (error) {
                console.error('é›¢é–‹æœƒè­°å¤±æ•—:', error);
            }
        }

        // ç¶å®šæŒ‰éˆ•äº‹ä»¶
        document.getElementById('startBtn').addEventListener('click', async () => {
            if (!isRecording) {
                const speakerOK = await initSpeakerDetection();
                if (speakerOK) {
                    // ä½¿ç”¨ AssemblyAI Batch æ¨¡å¼
                    const speechOK = await startAssemblyAIBatch();
                    if (speechOK) {
                        isRecording = true;
                        document.getElementById('startBtn').textContent = 'åœæ­¢éŒ„éŸ³';
                        document.getElementById('startBtn').classList.remove('btn-primary');
                        document.getElementById('startBtn').classList.add('btn-danger');

                        if (localStream) {
                            localStream.getAudioTracks().forEach(track => {
                                track.enabled = true;
                            });
                            isMicOn = true;
                        }
                    }
                }
            } else {
                if (localStream) {
                    localStream.getAudioTracks().forEach(track => {
                        track.enabled = false;
                    });
                    isMicOn = false;
                }
                stopAssemblyAIBatch();
                stopRecording();
            }
        });

        document.getElementById('leaveBtn').addEventListener('click', async () => {
            if (confirm('ç¢ºå®šè¦é›¢é–‹æœƒè­°å—ï¼Ÿ')) {
                stopAssemblyAIBatch();
                stopRecording();
                await leaveMeeting();
                // å›åˆ°æˆ¿é–“åˆ—è¡¨ï¼Œä¸ç™»å‡º
                window.location.href = 'index.html';
            }
        });


        document.getElementById('languageSelect').addEventListener('change', (e) => {
            if (recognition) {
                const wasRecording = isRecording;
                if (wasRecording) recognition.stop();
                recognition.lang = e.target.value;
                if (wasRecording) setTimeout(() => recognition.start(), 100);
            }
        });

        const toggleBtn = document.getElementById('toggleExpand');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', () => {
                const container = document.getElementById('captionContainer');
                container.classList.toggle('expanded');
                toggleBtn.textContent = container.classList.contains('expanded') ? 'æ”¶åˆå®Œæ•´è¦–åœ–' : 'å±•é–‹å®Œæ•´è¦–åœ–';
            });
        }

        // é é¢é—œé–‰æ™‚é›¢é–‹æœƒè­°
        window.addEventListener('beforeunload', () => {
            leaveMeeting();
        });

        console.log('=== æœƒè­°å®¤åˆå§‹åŒ–å®Œæˆ ===');

        // æ³¨æ„ï¼šinitPeerVoice, handleCall, playRemoteAudio ç­‰å‡½æ•¸å·²åœ¨ä¸Šæ–¹å®šç¾©

        // å–‡å­é–‹é—œ
        document.getElementById('speakerBtn').addEventListener('click', () => {
            isSpeakerOn = !isSpeakerOn;
            // æ§åˆ¶æ‰€æœ‰é ç«¯éŸ³è¨Šçš„éœéŸ³
            document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                audio.muted = !isSpeakerOn;
            });
            updateVoiceButtons();
            console.log('å–‡å­:', isSpeakerOn ? 'é–‹å•Ÿ' : 'é—œé–‰');
        });

        // éŸ³è¨Šè§£é–åŠŸèƒ½
        let audioUnlocked = false;

        function showAudioUnlockPrompt() {
            if (audioUnlocked) return;
            const overlay = document.getElementById('audioUnlockOverlay');
            if (overlay) {
                overlay.style.display = 'flex';
            }
        }

        function unlockAudio() {
            audioUnlocked = true;
            const overlay = document.getElementById('audioUnlockOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }

            // å˜—è©¦æ’­æ”¾æ‰€æœ‰ç¾æœ‰çš„éŸ³è¨Šå…ƒç´ 
            document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
                audio.play().then(() => {
                    console.log('ğŸ”Š éŸ³è¨Šå·²è§£é–ä¸¦æ’­æ”¾');
                }).catch(e => console.error('æ’­æ”¾å¤±æ•—:', e));
            });

            console.log('âœ… éŸ³è¨Šå·²è§£é–');
        }

        // ç¶å®šè§£é–æŒ‰éˆ•
        const unlockBtn = document.getElementById('unlockAudioBtn');
        if (unlockBtn) {
            unlockBtn.addEventListener('click', unlockAudio);
            unlockBtn.addEventListener('touchend', unlockAudio);  // æ‰‹æ©Ÿè§¸æ§
        }

        // ä»»ä½•ä½¿ç”¨è€…äº’å‹•éƒ½è§£é–éŸ³è¨Šï¼ˆåŒ…æ‹¬æ‰‹æ©Ÿè§¸æ§ï¼‰
        ['click', 'touchstart', 'touchend'].forEach(event => {
            document.addEventListener(event, () => {
                if (!audioUnlocked) {
                    unlockAudio();
                }
            }, { once: true });
        });

        // é€²å…¥æœƒè­°å®¤å¾Œè‡ªå‹•é€£æ¥èªéŸ³
        setTimeout(() => {
            if (currentUser) {
                initPeerVoice();
                // é¡¯ç¤ºè§£é–æç¤º
                showAudioUnlockPrompt();
            }
        }, 2000);
    </script>
</body>

</html>